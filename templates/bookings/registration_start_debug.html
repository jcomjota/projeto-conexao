{% extends 'base.html' %}

{% block title %}Debug CPF - {{ event.adventure.title }}{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 2rem auto; padding: 2rem; border: 1px solid #ccc;">
    <h2>🔧 DEBUG - Verificação de CPF</h2>
    <h3>{{ event.adventure.title }}</h3>
    <p><strong>Data:</strong> {{ event.date|date:"d/m/Y" }}</p>
    <p><strong>Preço:</strong> R$ {{ event.final_price }}</p>
    
    <hr>
    
    <form id="debugCpfForm">
        {% csrf_token %}
        <label for="debugCpfInput">Digite seu CPF:</label><br>
        <input type="text" 
               id="debugCpfInput" 
               placeholder="032.784.150-86"
               style="padding: 10px; margin: 10px 0; width: 200px;">
        <br>
        <button type="submit" id="debugSubmitBtn" style="padding: 10px 20px;">
            Verificar CPF
        </button>
    </form>
    
    <div id="debugLoading" style="display: none; color: blue; margin: 10px 0;">
        ⏳ Verificando CPF...
    </div>
    
    <div id="debugResult" style="margin: 10px 0; padding: 10px; background: #f5f5f5;"></div>
    
    <hr>
    
    <h4>🔍 Debug Info:</h4>
    <ul>
        <li><strong>Event ID:</strong> {{ event.id }}</li>
        <li><strong>URL da verificação:</strong> /reservas/event/{{ event.id }}/check-cpf/</li>
        <li><strong>CPF de teste:</strong> 032.784.150-86</li>
    </ul>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('debugCpfForm');
    const input = document.getElementById('debugCpfInput');
    const loading = document.getElementById('debugLoading');
    const result = document.getElementById('debugResult');
    const submitBtn = document.getElementById('debugSubmitBtn');
    
    // Máscara simples para CPF
    input.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d{1,2})/, '$1-$2');
        e.target.value = value;
    });
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const cpf = input.value.replace(/\D/g, '');
        
        result.innerHTML = '🚀 Iniciando verificação...';
        result.style.background = '#e3f2fd';
        
        if (cpf.length !== 11) {
            result.innerHTML = '❌ Erro: CPF deve ter 11 dígitos';
            result.style.background = '#ffebee';
            return;
        }
        
        // Mostrar loading
        loading.style.display = 'block';
        submitBtn.disabled = true;
        
        // Log para debug
        console.log('🔍 Debug Info:');
        console.log('CPF limpo:', cpf);
        console.log('URL:', `/reservas/event/{{ event.id }}/check-cpf/`);
        
        // Obter CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        console.log('CSRF Token:', csrfToken ? 'OK' : 'MISSING');
        
        // Fazer requisição
        fetch(`/reservas/event/{{ event.id }}/check-cpf/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
                cpf: cpf
            })
        })
        .then(response => {
            console.log('📡 Response status:', response.status);
            console.log('📡 Response headers:', response.headers);
            return response.json();
        })
        .then(data => {
            console.log('📦 Response data:', data);
            
            if (data.success) {
                result.innerHTML = `✅ Sucesso! Redirecionando para: ${data.redirect_url}`;
                result.style.background = '#e8f5e8';
                
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 2000);
            } else {
                result.innerHTML = `❌ Erro: ${data.error || 'Erro desconhecido'}`;
                result.style.background = '#ffebee';
            }
        })
        .catch(error => {
            console.error('🚨 Erro na requisição:', error);
            result.innerHTML = `🚨 Erro de conexão: ${error.message}`;
            result.style.background = '#ffebee';
        })
        .finally(() => {
            loading.style.display = 'none';
            submitBtn.disabled = false;
        });
    });
});
</script>
{% endblock %} 